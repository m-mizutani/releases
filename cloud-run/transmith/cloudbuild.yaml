steps:
  - id: "build"
    name: "gcr.io/cloud-builders/docker"
    args:
      - build
      - -f
      - cloud-run/transmith/Dockerfile
      - -t
      - "asia-northeast1-docker.pkg.dev/mztn-compute/container-images/transmith:$COMMIT_SHA"
      - cloud-run/transmith/
  - id: "push"
    name: "gcr.io/cloud-builders/docker"
    args:
      - push
      - "asia-northeast1-docker.pkg.dev/mztn-compute/container-images/transmith:$COMMIT_SHA"
  - id: "deploy"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      [
        "beta",
        "run",
        "deploy",
        "transmith",
        "--project=mztn-compute",
        "--image=asia-northeast1-docker.pkg.dev/mztn-compute/container-images/transmith:$COMMIT_SHA",
        "--region=asia-northeast1",
        "--ingress=all",
        "--memory=2Gi",
        "--set-secrets",
        "TRANSMITH_SLACK_OAUTH_TOKEN=projects/75418226798/secrets/TRANSMITH_SLACK_OAUTH_TOKEN:latest",
        "--args",
        "serve",
        "--service-account=transmith@mztn-compute.iam.gserviceaccount.com",
      ]
images:
  - "asia-northeast1-docker.pkg.dev/mztn-compute/container-images/transmith:$COMMIT_SHA"
options:
  logging: CLOUD_LOGGING_ONLY
